Database tables

-- Enable UUID generation (usually already enabled in Supabase)
create extension if not exists "pgcrypto";

-- 0) Create enum type if it doesn't exist yet
do $$
begin
  if not exists (select 1 from pg_type where typname = 'boat_type') then
    create type boat_type as enum ('sailboat', 'motorboat');
  end if;
end$$;

-- 1) Simple enum for registration status
do $$
begin
  if not exists (select 1 from pg_type where typname = 'registration_status') then
    create type registration_status as enum ('pending', 'approved', 'declined');
  end if;
end$$;

-- 1) Simple enum for profile type
do $$
begin
  if not exists (select 1 from pg_type where typname = 'profile_type') then
    create type profile_type as enum ('owner', 'crew');
  end if;
end$$;

-- 1) Simple enum for risk level
do $$
begin
  if not exists (select 1 from pg_type where typname = 'risk_level') then
    create type risk_level as enum ('Coastal sailing', 'Offshore sailing', 'Extreme sailing');
  end if;
end$$;

-- 1) Simple enum for journey state
do $$
begin
  if not exists (select 1 from pg_type where typname = 'journey_state') then
    create type journey_state as enum ('In planning', 'Published', 'Archived');
  end if;
end$$;


-- 2) profiles: one row per user, extends auth.users
create table if not exists public.profiles (
  id          uuid not null references auth.users(id) primary key,
  role        profile_type not null default 'crew',
  username    text,
  full_name   text,
  experience  text,          -- free text for now
  certifications text,       -- free text or JSON later
  phone       text,
  sailing_experience text,   -- 'Beginner', 'Confident Crew', 'Competent Coastal', 'Advanced'
  created_at  timestamptz not null default now(),
  updated_at  timestamptz not null default now()
);

create unique index if not exists profiles_user_id_key on public.profiles (id);

-- enable sec
alter table profiles enable row level security;

-- setup basic policies
create policy "Public profiles are viewable by all"
on profiles for select
using (true);

create policy "Users can insert their own profile"
on profiles for insert
with check (auth.uid() = id);

create policy "Users can update own profile"
on profiles for update
using (auth.uid() = id);


-- 3) boats
create table if not exists public.boats (
  id          uuid primary key default gen_random_uuid(),
  owner_id    uuid not null references auth.users (id) on delete cascade,
  name        text not null,
  type        boat_type not null default 'sailboat',
  make        text,
  model       text,
  capacity    int,
  home_port   text, 
  loa_m       numeric, -- length overall in meters
  beam_m      numeric, -- Beam in meters
  displcmt_m  numeric, -- Displacement in kg
  link_to_specs text, -- Link to additional information like sailboatdata.com
  images      text[] default '{}',  -- store image URLs from Supabase Storage
  created_at  timestamptz not null default now(),
  updated_at  timestamptz not null default now()
);

create index if not exists boats_owner_id_idx on public.boats (owner_id);
alter table boats enable row level security;

-- basic policies
create policy "Boats are accessible to all"
on boats for select
using(true);

-- owners can insert their boats
create policy "Owners can insert their boats"
on boats for insert
with check (auth.uid() = owner_id);

create policy "Owners can update their boat details"
on boats for update
using(auth.uid() = owner_id);

create policy "Onwers can delete their boats"
on boats for delete
using(auth.uid() = owner_id);

-- 4) journeys
create table if not exists public.journeys (
  id           uuid primary key default gen_random_uuid(),
  boat_id      uuid not null references public.boats (id) on delete cascade,
  name         text not null,
  start_date   date,
  end_date     date,
  description  text,
  risk_level   risk_level[] default '{}',
  state        journey_state not null default 'In planning',
  created_at   timestamptz not null default now(),
  updated_at   timestamptz not null default now()
);

create index if not exists journeys_boat_id_idx on public.journeys (boat_id);
create index if not exists journeys_state_idx on public.journeys (state);

-- Enable RLS on journeys
alter table journeys enable row level security;

-- Journeys policies
-- Only published journeys are viewable by everyone, owners can see all their journeys
create policy "Published journeys are viewable by all"
on journeys for select
using (
  state = 'Published'::journey_state
  or exists (
    select 1 from boats
    where boats.id = journeys.boat_id
    and boats.owner_id = auth.uid()
  )
);

create policy "Owners can insert journeys for their boats"
on journeys for insert
with check (
  exists (
    select 1 from boats
    where boats.id = journeys.boat_id
    and boats.owner_id = auth.uid()
  )
);

create policy "Owners can update their own journeys"
on journeys for update
using (
  exists (
    select 1 from boats
    where boats.id = journeys.boat_id
    and boats.owner_id = auth.uid()
  )
);

create policy "Owners can delete their own journeys"
on journeys for delete
using (
  exists (
    select 1 from boats
    where boats.id = journeys.boat_id
    and boats.owner_id = auth.uid()
  )
);

-- 5) legs
create table if not exists public.legs (
  id           uuid primary key default gen_random_uuid(),
  journey_id   uuid not null references public.journeys (id) on delete cascade,
  name         text not null,
  waypoints    jsonb default '[]',  -- Array of waypoints: [{"index": 0, "geocode": {"type": "Point", "coordinates": [lng, lat]}, "name": "Location name"}, ...]
  start_date   timestamptz,
  end_date     timestamptz,
  crew_needed  int,
  skills       text[] default '{}',  -- simple array of skill tags
  created_at   timestamptz not null default now(),
  updated_at   timestamptz not null default now()
);

create index if not exists legs_journey_id_idx on public.legs (journey_id);
create index if not exists legs_waypoints_idx on public.legs using gin (waypoints);

-- Enable RLS on legs
alter table legs enable row level security;

-- Legs policies
create policy "Legs are viewable by all"
on legs for select
using (true);

create policy "Owners can insert legs for their journeys"
on legs for insert
with check (
  exists (
    select 1 from journeys
    join boats on boats.id = journeys.boat_id
    where journeys.id = legs.journey_id
    and boats.owner_id = auth.uid()
  )
);

create policy "Owners can update their own legs"
on legs for update
using (
  exists (
    select 1 from journeys
    join boats on boats.id = journeys.boat_id
    where journeys.id = legs.journey_id
    and boats.owner_id = auth.uid()
  )
);

create policy "Owners can delete their own legs"
on legs for delete
using (
  exists (
    select 1 from journeys
    join boats on boats.id = journeys.boat_id
    where journeys.id = legs.journey_id
    and boats.owner_id = auth.uid()
  )
);

-- 6) registrations
create table if not exists public.registrations (
  id           uuid primary key default gen_random_uuid(),
  leg_id       uuid not null references public.legs (id) on delete cascade,
  user_id      uuid not null references auth.users (id) on delete cascade,
  status       registration_status not null default 'pending',
  created_at   timestamptz not null default now(),
  updated_at   timestamptz not null default now()
);

create index if not exists registrations_leg_id_idx on public.registrations (leg_id);
create index if not exists registrations_user_id_idx on public.registrations (user_id);
create unique index if not exists registrations_leg_user_unique
  on public.registrations (leg_id, user_id);

-- Storage bucket policies for boat-images
-- Note: First create the bucket in Supabase Dashboard > Storage > New bucket
-- Name: boat-images, Public: true

-- Allow authenticated users to upload images to their own folder
create policy "Authenticated users can upload boat images"
on storage.objects for insert
to authenticated
with check (
  bucket_id = 'boat-images' 
  and (storage.foldername(name))[1] = auth.uid()::text
);

-- Allow public to view boat images
create policy "Public can view boat images"
on storage.objects for select
to public
using (bucket_id = 'boat-images');

-- Allow users to update their own images
create policy "Users can update their own boat images"
on storage.objects for update
to authenticated
using (
  bucket_id = 'boat-images' 
  and (storage.foldername(name))[1] = auth.uid()::text
)
with check (
  bucket_id = 'boat-images' 
  and (storage.foldername(name))[1] = auth.uid()::text
);

-- Allow users to delete their own images
create policy "Users can delete their own boat images"
on storage.objects for delete
to authenticated
using (
  bucket_id = 'boat-images' 
  and (storage.foldername(name))[1] = auth.uid()::text
);