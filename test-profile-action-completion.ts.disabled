/**
 * Test script to verify profile action completion functionality
 */

import { test, expect } from '@playwright/test';

test.describe('Profile Action Completion', () => {
  test('should mark redirected actions as completed after profile update', async ({ page }) => {
    // Navigate to profile page
    await page.goto('/profile');

    // Wait for assistant context to load
    await page.waitForSelector('[data-testid="assistant-context"]');

    // Simulate a redirected action in the database
    // This would need to be done via API or database seeding in a real test

    // Update a profile field that matches an action
    await page.fill('#user_description', 'Updated user description for testing');

    // Save the profile
    await page.click('button[type="submit"]');

    // Wait for success message
    await page.waitForSelector('.toast-success');

    // Verify the action was marked as completed
    // This would need to check the database or API response
    // For now, we'll just verify the profile update worked
    await expect(page.locator('#user_description')).toHaveValue('Updated user description for testing');

    // Check that the action status was updated
    // This would require checking the pending actions API
    const response = await page.request.get('/api/ai/assistant/actions');
    const actions = await response.json();

    // Find any redirected actions for profile fields and verify they're now approved
    const profileActions = actions.filter((a: any) =>
      a.status === 'approved' &&
      (a.action_type.includes('update_profile') || a.action_type.includes('suggest_profile'))
    );

    expect(profileActions.length).toBeGreaterThan(0);
  });

  test('should handle profile update event with field tracking', async ({ page }) => {
    // Listen for the profileUpdated event
    await page.evaluate(() => {
      window.addEventListener('profileUpdated', (event: any) => {
        window.profileUpdateEvent = event.detail;
      });
    });

    // Navigate to profile page
    await page.goto('/profile');

    // Update profile field
    await page.fill('#certifications', 'Updated certifications');

    // Save the profile
    await page.click('button[type="submit"]');

    // Wait for success and check event
    await page.waitForTimeout(1000);

    const profileUpdateEvent = await page.evaluate(() => window.profileUpdateEvent);
    expect(profileUpdateEvent).toBeDefined();
    expect(profileUpdateEvent.updatedFields).toContain('certifications');
  });
});